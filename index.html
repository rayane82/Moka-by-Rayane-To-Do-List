<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Moka by Rayane - Syst√®me de Productivit√©</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;600;700&family=Playfair+Display:wght@700;900&display=swap" rel="stylesheet">
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <style>
        :root {
            /* Palette Moka by Rayane */
            --moka-bg: #FDFBF8;         /* Blanc Cass√© / Cr√®me */
            --moka-chocolate: #8B5A2B;  /* Marron Chocolat */
            --moka-taupe: #A67C52;      /* Marron Clair / Taupe */
            --moka-gold-start: #C59267; /* D√©grad√© Or Cuivr√© D√©but */
            --moka-gold-end: #E8D1B5;   /* D√©grad√© Or Cuivr√© Fin */
            --moka-white: #FFFFFF;
        }

        body {
            font-family: 'Montserrat', sans-serif;
            background-color: var(--moka-bg);
            color: var(--moka-chocolate);
            overflow-x: hidden;
            -webkit-tap-highlight-color: transparent;
        }

        h1, h2, h3, .font-display {
            font-family: 'Playfair Display', serif;
            color: var(--moka-chocolate);
        }

        /* Animations */
        .slide-in {
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .fade-in {
            animation: fadeIn 0.4s ease-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .sidebar-overlay {
            background: rgba(139, 90, 43, 0.2);
            backdrop-filter: blur(4px);
            transition: opacity 0.3s ease;
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 4px;
        }
        ::-webkit-scrollbar-thumb {
            background: var(--moka-gold-start);
            border-radius: 10px;
        }

        /* Glassmorphism */
        .glass {
            background: rgba(253, 251, 248, 0.9);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(197, 146, 103, 0.15);
        }

        /* Boutons avec D√©grad√© Or/Cuivr√© */
        .btn-moka-gold {
            background: linear-gradient(135deg, var(--moka-gold-start) 0%, var(--moka-gold-end) 100%);
            color: white;
            box-shadow: 0 4px 14px rgba(197, 146, 103, 0.4);
            border: none;
        }

        .text-moka-chocolate { color: var(--moka-chocolate); }
        .text-moka-taupe { color: var(--moka-taupe); }
        .bg-moka-chocolate { background-color: var(--moka-chocolate); }
        
        .progress-bar-gold {
            background: linear-gradient(90deg, var(--moka-gold-start), var(--moka-gold-end));
        }
        
        .progress-bar-chocolate {
            background-color: var(--moka-chocolate);
        }

        .card-shadow {
            box-shadow: 0 10px 25px -5px rgba(139, 90, 43, 0.08);
        }

        .task-checkbox:checked + label .check-box {
            background-color: var(--moka-chocolate);
            border-color: var(--moka-chocolate);
        }

        .logo-header {
            height: 44px;
            width: auto;
            object-fit: contain;
        }

        .logo-footer {
            height: 90px;
            width: auto;
            object-fit: contain;
            filter: drop-shadow(0 4px 6px rgba(0,0,0,0.05));
        }
    </style>
</head>
<body class="min-h-screen">

    <!-- LOGIN SCREEN -->
    <div id="screen-login" class="fixed inset-0 z-[100] bg-[#FDFBF8] flex items-center justify-center p-6 transition-opacity duration-500">
        <div class="w-full max-w-md space-y-8 fade-in text-center">
            <div class="relative inline-block">
                <div class="absolute inset-0 bg-[#C59267] rounded-full blur-3xl opacity-10 animate-pulse"></div>
                <img src="https://i.postimg.cc/V67FwHSr/7fad8d1f-9815-44c3-9d3b-0e8d11d95c71.png" alt="Logo Moka" class="relative w-44 h-44 mx-auto rounded-full border-4 border-white mb-6 object-cover shadow-2xl">
            </div>
            
            <div class="space-y-1">
                <h1 class="text-4xl font-black text-moka-chocolate uppercase tracking-tighter">Moka</h1>
                <p class="text-moka-taupe opacity-90 font-medium italic">by Rayane</p>
                <div class="pt-2">
                    <span class="px-3 py-1 bg-white border border-stone-100 rounded-full text-[10px] font-bold tracking-widest text-moka-gold-start uppercase">L'excellence au quotidien</span>
                </div>
            </div>
            
            <form id="login-form" class="space-y-4 bg-white p-8 rounded-[2.5rem] border border-stone-50 shadow-2xl text-left">
                <div>
                    <label class="block text-xs uppercase tracking-widest text-moka-chocolate font-black mb-2 ml-1">Identit√©</label>
                    <input type="text" id="login-name" required placeholder="Votre nom" class="w-full bg-stone-50 border border-stone-100 rounded-2xl px-5 py-4 focus:outline-none focus:ring-2 focus:ring-[#C59267] transition-all text-moka-chocolate placeholder-stone-300 font-medium">
                </div>
                <div>
                    <label class="block text-xs uppercase tracking-widest text-moka-chocolate font-black mb-2 ml-1">WhatsApp</label>
                    <input type="tel" id="login-whatsapp" required placeholder="Ex: 212600000000" class="w-full bg-stone-50 border border-stone-100 rounded-2xl px-5 py-4 focus:outline-none focus:ring-2 focus:ring-[#C59267] transition-all text-moka-chocolate placeholder-stone-300 font-medium">
                </div>
                <button type="submit" class="w-full btn-moka-gold py-5 rounded-2xl font-black uppercase tracking-widest hover:brightness-105 active:scale-[0.98] transition-all mt-4">
                    Initialiser mon espace
                </button>
            </form>
            <p class="text-[10px] text-moka-taupe uppercase tracking-widest font-semibold opacity-40">Moka Productivity Ecosystem ‚Ä¢ by Rayane</p>
        </div>
    </div>

    <!-- MAIN APP WRAPPER -->
    <div id="app-container" class="hidden min-h-screen flex flex-col">
        
        <!-- SIDEBAR -->
        <div id="sidebar-overlay" class="fixed inset-0 z-40 sidebar-overlay opacity-0 pointer-events-none transition-all"></div>
        <aside id="sidebar" class="fixed top-0 left-0 h-full w-80 bg-white z-50 transform -translate-x-full slide-in shadow-2xl overflow-y-auto border-r border-stone-50">
            <div class="p-8 space-y-10">
                <!-- User Profile -->
                <div class="flex flex-col items-center text-center space-y-4 pb-8 border-b border-stone-50">
                    <div class="w-24 h-24 rounded-full p-1 border-2 border-moka-gold-start shadow-lg overflow-hidden">
                        <img src="https://i.postimg.cc/V67FwHSr/7fad8d1f-9815-44c3-9d3b-0e8d11d95c71.png" class="w-full h-full rounded-full object-cover">
                    </div>
                    <div>
                        <h3 id="sidebar-user-name" class="text-2xl font-black text-moka-chocolate">Rayane</h3>
                        <p class="text-[10px] text-moka-taupe font-black uppercase tracking-[0.2em]">‚òï Focus Actif</p>
                    </div>
                </div>

                <!-- Progress Bars -->
                <div class="space-y-8">
                    <div class="bg-stone-50 p-5 rounded-3xl border border-stone-100">
                        <div class="flex justify-between text-[10px] mb-3">
                            <span class="text-moka-chocolate font-black uppercase">Moka Daily</span>
                            <span id="daily-progress-text" class="text-moka-chocolate font-black">0%</span>
                        </div>
                        <div class="h-2.5 w-full bg-white rounded-full overflow-hidden shadow-inner">
                            <div id="daily-progress-bar" class="h-full progress-bar-gold transition-all duration-1000 ease-out" style="width: 0%"></div>
                        </div>
                    </div>
                    <div class="bg-stone-50 p-5 rounded-3xl border border-stone-100">
                        <div class="flex justify-between text-[10px] mb-3">
                            <span class="text-moka-chocolate font-black uppercase">Moka Weekly</span>
                            <span id="weekly-progress-text" class="text-moka-taupe font-black">0%</span>
                        </div>
                        <div class="h-2.5 w-full bg-white rounded-full overflow-hidden shadow-inner">
                            <div id="weekly-progress-bar" class="h-full progress-bar-chocolate transition-all duration-1000 ease-out" style="width: 0%"></div>
                        </div>
                    </div>
                </div>

                <!-- Navigation -->
                <nav class="space-y-3">
                    <button onclick="switchView('dashboard')" class="w-full flex items-center space-x-4 p-4 rounded-2xl hover:bg-stone-50 transition-all text-moka-taupe hover:text-moka-chocolate group">
                        <i data-lucide="layout-dashboard" class="w-5 h-5 group-hover:scale-110 transition-transform"></i>
                        <span class="font-bold">Dashboard Global</span>
                    </button>
                    <button onclick="switchView('daily')" class="w-full flex items-center space-x-4 p-4 rounded-2xl hover:bg-stone-50 transition-all text-moka-taupe hover:text-moka-chocolate group">
                        <i data-lucide="coffee" class="w-5 h-5 group-hover:scale-110 transition-transform"></i>
                        <span class="font-bold">Moka Daily</span>
                    </button>
                    <button onclick="switchView('weekly')" class="w-full flex items-center space-x-4 p-4 rounded-2xl hover:bg-stone-50 transition-all text-moka-taupe hover:text-moka-chocolate group">
                        <i data-lucide="calendar" class="w-5 h-5 group-hover:scale-110 transition-transform"></i>
                        <span class="font-bold">Moka Weekly</span>
                    </button>
                    <button onclick="switchView('profile')" class="w-full flex items-center space-x-4 p-4 rounded-2xl hover:bg-stone-50 transition-all text-moka-taupe hover:text-moka-chocolate group">
                        <i data-lucide="user" class="w-5 h-5 group-hover:scale-110 transition-transform"></i>
                        <span class="font-bold">Mon Profil</span>
                    </button>
                </nav>

                <div class="pt-8 border-t border-stone-100 space-y-2">
                    <button onclick="logout()" class="w-full flex items-center space-x-4 p-4 rounded-2xl text-moka-chocolate hover:bg-stone-50 transition-all font-bold">
                        <i data-lucide="users" class="w-5 h-5"></i>
                        <span>Changer de Profil</span>
                    </button>
                    <button onclick="logout()" class="w-full flex items-center space-x-4 p-4 rounded-2xl text-stone-400 hover:bg-red-50 hover:text-red-600 transition-all">
                        <i data-lucide="log-out" class="w-5 h-5"></i>
                        <span class="font-bold">D√©connexion</span>
                    </button>
                </div>
            </div>
        </aside>

        <!-- TOP BAR (NAV BAR) -->
        <header class="sticky top-0 z-30 flex items-center justify-between px-6 py-4 bg-[#FDFBF8] border-b border-stone-100">
            <button id="menu-btn" class="p-3 bg-stone-50 hover:bg-white rounded-2xl transition-all border border-stone-100 shadow-sm text-moka-chocolate">
                <i data-lucide="menu" class="w-6 h-6"></i>
            </button>
            <div class="flex flex-col items-center">
                <img src="https://i.postimg.cc/V67FwHSr/7fad8d1f-9815-44c3-9d3b-0e8d11d95c71.png" alt="Moka Logo" class="logo-header">
                <div id="view-title-label" class="hidden text-[8px] font-black tracking-[0.2em] text-moka-chocolate uppercase mt-1">Dashboard Global</div>
            </div>
            <button onclick="exportWhatsApp('all')" class="p-3 bg-stone-50 text-moka-chocolate rounded-2xl hover:bg-moka-chocolate hover:text-white transition-all border border-stone-100 shadow-sm">
                <i data-lucide="send" class="w-6 h-6"></i>
            </button>
        </header>

        <!-- CONTENT VIEWS -->
        <main class="flex-grow p-6 pb-12 overflow-x-hidden max-w-lg mx-auto w-full">
            
            <!-- DASHBOARD VIEW -->
            <section id="view-dashboard" class="space-y-10 fade-in">
                <!-- Stat Cards -->
                <div class="grid grid-cols-2 gap-5">
                    <div class="bg-white p-6 rounded-[2.5rem] shadow-xl card-shadow border border-stone-50 space-y-4 relative overflow-hidden group">
                        <div class="absolute top-0 right-0 w-20 h-20 bg-[#FDFBF8] rounded-full -mr-8 -mt-8 group-hover:scale-125 transition-transform duration-500"></div>
                        <div class="w-12 h-12 bg-stone-50 text-moka-gold-start flex items-center justify-center rounded-2xl relative border border-stone-100">
                            <i data-lucide="zap" class="w-6 h-6"></i>
                        </div>
                        <div class="relative">
                            <p class="text-[9px] text-moka-taupe font-black uppercase tracking-widest">Score Daily</p>
                            <h4 id="dash-daily-stat" class="text-3xl font-black text-moka-chocolate">0%</h4>
                        </div>
                    </div>
                    <div class="bg-moka-chocolate p-6 rounded-[2.5rem] shadow-xl space-y-4 relative overflow-hidden group">
                        <div class="absolute top-0 right-0 w-20 h-20 bg-white/5 rounded-full -mr-8 -mt-8 group-hover:scale-125 transition-transform duration-500"></div>
                        <div class="w-12 h-12 bg-white/10 text-moka-gold-end flex items-center justify-center rounded-2xl relative">
                            <i data-lucide="bar-chart" class="w-6 h-6"></i>
                        </div>
                        <div class="relative">
                            <p class="text-[9px] text-white/40 font-black uppercase tracking-widest">Moyenne Weekly</p>
                            <h4 id="dash-weekly-stat" class="text-3xl font-black text-white">0%</h4>
                        </div>
                    </div>
                </div>

                <!-- Next Tasks Preview -->
                <div class="space-y-5">
                    <div class="flex items-center justify-between px-2">
                        <h3 class="text-xl font-black text-moka-chocolate tracking-tight">Focus Imm√©diat</h3>
                        <button onclick="switchView('daily')" class="text-[9px] text-moka-gold-start font-black uppercase tracking-widest hover:underline">Voir listes</button>
                    </div>
                    <div id="dashboard-tasks-list" class="space-y-4">
                        <!-- Dynamic content -->
                    </div>
                </div>
            </section>

            <!-- DAILY TASKS VIEW -->
            <section id="view-daily" class="hidden space-y-8 fade-in">
                <div class="flex items-center justify-between px-2">
                    <div>
                        <h2 class="text-2xl font-black text-moka-chocolate">Moka Daily</h2>
                        <p class="text-moka-taupe text-sm font-bold italic opacity-60">Le rituel de chaque matin.</p>
                    </div>
                    <button onclick="confirmReset('daily')" class="p-3 text-stone-300 hover:text-red-400 hover:bg-red-50 rounded-2xl transition-all">
                        <i data-lucide="rotate-ccw" class="w-5 h-5"></i>
                    </button>
                </div>
                
                <form id="add-daily-form" class="space-y-3 bg-white p-4 rounded-[2rem] shadow-xl border border-stone-100">
                    <input type="text" id="daily-input" placeholder="Nouvelle action..." class="w-full px-5 py-4 rounded-2xl bg-stone-50 focus:outline-none focus:ring-2 focus:ring-[#C59267] transition-all text-moka-chocolate font-medium placeholder-stone-300">
                    <div class="flex space-x-3">
                        <input type="time" id="daily-time" class="flex-1 px-5 py-3 rounded-2xl bg-stone-50 focus:outline-none focus:ring-2 focus:ring-[#C59267] transition-all text-moka-chocolate font-medium">
                        <button type="submit" class="px-6 py-4 btn-moka-gold text-white rounded-2xl shadow-lg hover:scale-105 active:scale-95 transition-all">
                            <i data-lucide="plus" class="w-6 h-6"></i>
                        </button>
                    </div>
                </form>

                <div id="daily-list" class="space-y-4">
                    <!-- Tasks here -->
                </div>
            </section>

            <!-- WEEKLY TASKS VIEW -->
            <section id="view-weekly" class="hidden space-y-8 fade-in">
                <div class="flex items-center justify-between px-2">
                    <div>
                        <h2 class="text-2xl font-black text-moka-chocolate">Moka Weekly</h2>
                        <p class="text-moka-taupe text-sm font-bold italic opacity-60">La vision √† long terme.</p>
                    </div>
                    <div class="flex space-x-1">
                        <button onclick="exportWhatsApp('weekly')" class="p-3 text-moka-chocolate hover:text-moka-taupe rounded-2xl transition-all" title="Exporter rapport hebdo">
                            <i data-lucide="send" class="w-5 h-5"></i>
                        </button>
                        <button onclick="confirmReset('weekly')" class="p-3 text-stone-300 hover:text-red-400 hover:bg-red-50 rounded-2xl transition-all">
                            <i data-lucide="rotate-ccw" class="w-5 h-5"></i>
                        </button>
                    </div>
                </div>

                <form id="add-weekly-form" class="space-y-3 bg-white p-4 rounded-[2rem] shadow-xl border border-stone-100">
                    <input type="text" id="weekly-input" placeholder="Objectif strat√©gique..." class="w-full px-5 py-4 rounded-2xl bg-stone-50 focus:outline-none focus:ring-2 focus:ring-[#8B5A2B] transition-all text-moka-chocolate font-medium placeholder-stone-300">
                    <div class="flex space-x-3">
                        <input type="text" id="weekly-day" placeholder="Jour (ex: Lundi)" class="flex-1 px-5 py-3 rounded-2xl bg-stone-50 focus:outline-none focus:ring-2 focus:ring-[#8B5A2B] transition-all text-moka-chocolate font-medium placeholder-stone-300">
                        <button type="submit" class="px-6 py-4 bg-moka-chocolate text-white rounded-2xl shadow-lg hover:scale-105 active:scale-95 transition-all">
                            <i data-lucide="plus" class="w-6 h-6"></i>
                        </button>
                    </div>
                </form>

                <div id="weekly-list" class="space-y-4">
                    <!-- Tasks here -->
                </div>
            </section>

            <!-- PROFILE VIEW -->
            <section id="view-profile" class="hidden space-y-8 fade-in">
                <div class="flex flex-col items-center justify-center p-8 bg-white rounded-[2.5rem] shadow-xl border border-stone-50 space-y-6">
                    <div class="w-32 h-32 rounded-full p-1 border-4 border-moka-gold-start shadow-2xl overflow-hidden">
                        <img src="https://i.postimg.cc/V67FwHSr/7fad8d1f-9815-44c3-9d3b-0e8d11d95c71.png" class="w-full h-full rounded-full object-cover">
                    </div>
                    <div class="text-center">
                        <h2 id="profile-name" class="text-3xl font-black text-moka-chocolate">Utilisateur</h2>
                        <p id="profile-whatsapp" class="text-moka-taupe font-bold">+212 6 XX XX XX XX</p>
                    </div>
                    <div class="w-full pt-6 border-t border-stone-50 flex flex-col space-y-4">
                        <div class="flex justify-between items-center px-4">
                            <span class="text-xs uppercase font-black text-stone-400">Statut √âcosyst√®me</span>
                            <span class="px-3 py-1 bg-stone-50 rounded-full text-[10px] font-black text-moka-gold-start uppercase">Membre Actif</span>
                        </div>
                        <div class="flex justify-between items-center px-4">
                            <span class="text-xs uppercase font-black text-stone-400">√âdition</span>
                            <span class="text-[10px] font-black text-moka-chocolate uppercase">Moka V2 2026</span>
                        </div>
                    </div>
                </div>
                <div class="space-y-3">
                    <button onclick="logout()" class="w-full py-5 rounded-[2rem] bg-moka-chocolate text-white font-black uppercase tracking-widest transition-all hover:brightness-110 shadow-lg">
                        Changer de profil
                    </button>
                    <button onclick="logout()" class="w-full py-5 rounded-[2rem] bg-red-50 text-red-600 font-black uppercase tracking-widest transition-all hover:bg-red-100">
                        D√©connecter mon profil
                    </button>
                </div>
            </section>

        </main>

        <!-- FOOTER -->
        <footer class="p-10 bg-[#FDFBF8] border-t border-stone-100 text-center space-y-6">
            <div class="flex flex-col items-center justify-center space-y-4">
                <img src="https://i.postimg.cc/V67FwHSr/7fad8d1f-9815-44c3-9d3b-0e8d11d95c71.png" alt="Moka Logo Footer" class="logo-footer">
                <div class="space-y-1">
                    <h4 class="text-moka-chocolate font-black tracking-[0.2em] uppercase text-sm">Moka by Rayane</h4>
                    <p class="text-moka-taupe text-[10px] font-bold opacity-60 uppercase tracking-[0.3em]">L'excellence est un rituel</p>
                </div>
            </div>
            <div class="pt-6 border-t border-stone-50 max-w-xs mx-auto">
                <p class="mt-4 text-[9px] text-moka-taupe font-black uppercase tracking-widest opacity-40 text-center">
                    ¬© 2026 Moka by rayane
                </p>
            </div>
        </footer>
    </div>

    <!-- Notification / Toast -->
    <div id="toast" class="fixed bottom-10 left-1/2 -translate-x-1/2 px-8 py-4 bg-moka-chocolate text-white rounded-full shadow-2xl z-[100] opacity-0 pointer-events-none transition-all duration-500 transform translate-y-10 flex items-center space-x-3 border border-white/5">
        <i data-lucide="check-circle" class="w-5 h-5 text-moka-gold-end"></i>
        <span class="font-bold text-sm">Synchronisation effectu√©e</span>
    </div>

    <script>
        // --- CONFIG & STATE ---
        let currentUser = null;
        let state = {
            daily: [],
            weekly: []
        };

        const STORAGE_PREFIX = "moka_prod_sys_v2_";

        // --- DOM ELEMENTS ---
        const screens = {
            login: document.getElementById('screen-login'),
            app: document.getElementById('app-container'),
            dashboard: document.getElementById('view-dashboard'),
            daily: document.getElementById('view-daily'),
            weekly: document.getElementById('view-weekly'),
            profile: document.getElementById('view-profile')
        };

        const sidebar = document.getElementById('sidebar');
        const overlay = document.getElementById('sidebar-overlay');
        const viewTitleLabel = document.getElementById('view-title-label');

        // --- CORE FUNCTIONS ---

        function init() {
            const savedUser = localStorage.getItem('moka_session_user_v2');
            if (savedUser) {
                loginAs(JSON.parse(savedUser));
            }
            lucide.createIcons();
        }

        function loginAs(user) {
            currentUser = user;
            localStorage.setItem('moka_session_user_v2', JSON.stringify(user));
            
            const dbKey = STORAGE_PREFIX + user.name.toLowerCase().trim();
            const savedData = localStorage.getItem(dbKey);
            if (savedData) {
                state = JSON.parse(savedData);
            } else {
                state = { daily: [], weekly: [] };
            }

            document.getElementById('sidebar-user-name').innerText = user.name;
            document.getElementById('profile-name').innerText = user.name;
            document.getElementById('profile-whatsapp').innerText = '+' + user.whatsapp;

            screens.login.classList.add('opacity-0', 'pointer-events-none');
            setTimeout(() => {
                screens.login.classList.add('hidden');
                screens.app.classList.remove('hidden');
                switchView('dashboard');
                updateAllUI();
            }, 500);
        }

        function logout() {
            localStorage.removeItem('moka_session_user_v2');
            location.reload();
        }

        function saveState() {
            if (!currentUser) return;
            const dbKey = STORAGE_PREFIX + currentUser.name.toLowerCase().trim();
            localStorage.setItem(dbKey, JSON.stringify(state));
            updateProgress();
        }

        function switchView(viewId) {
            const labels = {
                dashboard: "Dashboard Global",
                daily: "Moka Daily",
                weekly: "Moka Weekly",
                profile: "Mon Profil"
            };
            
            if (viewTitleLabel) {
                viewTitleLabel.innerText = labels[viewId] || "Moka by Rayane";
                viewTitleLabel.classList.remove('hidden');
            }

            Object.values(screens).forEach(s => {
                if(s !== screens.app && s !== screens.login) s.classList.add('hidden');
            });

            screens[viewId].classList.remove('hidden');
            closeSidebar();
            updateAllUI();
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function openSidebar() {
            sidebar.classList.remove('-translate-x-full');
            overlay.classList.remove('opacity-0', 'pointer-events-none');
            overlay.classList.add('opacity-100');
        }

        function closeSidebar() {
            sidebar.classList.add('-translate-x-full');
            overlay.classList.add('opacity-0', 'pointer-events-none');
            overlay.classList.remove('opacity-100');
        }

        function addTask(type, title, extra) {
            if (!title.trim()) return;
            const newTask = {
                id: Date.now(),
                title: title.trim(),
                extra: extra || "", // Time for daily, Day for weekly
                done: false,
                createdAt: new Date()
            };
            state[type].unshift(newTask);
            saveState();
            updateAllUI();
            showToast("Objectif enregistr√©");
        }

        function toggleTask(type, id) {
            const task = state[type].find(t => t.id === id);
            if (task) {
                task.done = !task.done;
                saveState();
                updateAllUI();
            }
        }

        function deleteTask(type, id) {
            state[type] = state[type].filter(t => t.id !== id);
            saveState();
            updateAllUI();
        }

        function confirmReset(type) {
            const name = type === 'daily' ? 'Moka Daily' : 'Moka Weekly';
            if (confirm(`Voulez-vous r√©initialiser votre liste ${name} ?`)) {
                state[type] = [];
                saveState();
                updateAllUI();
                showToast("Liste pr√™te pour de nouveaux d√©fis.");
            }
        }

        // --- UI UPDATES ---

        function updateAllUI() {
            renderList('daily');
            renderList('weekly');
            renderDashboardPreview();
            updateProgress();
            lucide.createIcons();
        }

        function renderList(type) {
            const container = document.getElementById(`${type}-list`);
            container.innerHTML = '';
            
            if (state[type].length === 0) {
                container.innerHTML = `
                    <div class="text-center py-16 opacity-30">
                        <div class="mb-4 inline-block bg-white p-6 rounded-full shadow-sm border border-stone-100">
                             <i data-lucide="coffee" class="w-10 h-10 text-moka-chocolate"></i>
                        </div>
                        <p class="font-black text-moka-chocolate uppercase text-[10px] tracking-widest italic">Aucune donn√©e pour le moment.</p>
                    </div>
                `;
                return;
            }

            const sorted = [...state[type]].sort((a,b) => a.done - b.done);

            sorted.forEach(task => {
                const div = document.createElement('div');
                div.className = `flex items-center space-x-4 p-5 rounded-3xl border transition-all duration-300 ${task.done ? 'bg-stone-50 border-transparent opacity-40 scale-[0.97]' : 'bg-white border-stone-100 shadow-lg'}`;
                div.innerHTML = `
                    <div class="relative flex items-center justify-center">
                        <input type="checkbox" id="task-${task.id}" ${task.done ? 'checked' : ''} onchange="toggleTask('${type}', ${task.id})" class="hidden task-checkbox">
                        <label for="task-${task.id}" class="w-8 h-8 border-2 ${task.done ? 'bg-moka-chocolate border-moka-chocolate' : 'border-stone-200'} rounded-2xl cursor-pointer flex items-center justify-center transition-all shadow-inner check-box">
                            <i data-lucide="check" class="w-4 h-4 text-white ${task.done ? '' : 'hidden'}"></i>
                        </label>
                    </div>
                    <div class="flex-1 cursor-pointer" onclick="document.getElementById('task-${task.id}').click()">
                        <p class="font-bold text-moka-chocolate ${task.done ? 'line-through opacity-70' : ''}">${task.title}</p>
                        ${task.extra ? `<p class="text-[9px] font-black uppercase text-moka-gold-start tracking-wider">${task.extra}</p>` : ''}
                    </div>
                    <button onclick="deleteTask('${type}', ${task.id})" class="text-stone-300 hover:text-red-400 transition-colors p-2">
                        <i data-lucide="trash-2" class="w-5 h-5"></i>
                    </button>
                `;
                container.appendChild(div);
            });
            lucide.createIcons();
        }

        function renderDashboardPreview() {
            const container = document.getElementById('dashboard-tasks-list');
            container.innerHTML = '';
            
            const pendingDaily = state.daily.filter(t => !t.done).slice(0, 2);
            const pendingWeekly = state.weekly.filter(t => !t.done).slice(0, 2);
            const allPending = [...pendingDaily, ...pendingWeekly];

            if (allPending.length === 0) {
                container.innerHTML = `
                    <div class="bg-white p-8 rounded-[2.5rem] border border-stone-50 text-center space-y-3 shadow-xl">
                        <i data-lucide="award" class="w-8 h-8 mx-auto text-moka-gold-start opacity-30"></i>
                        <p class="font-black text-moka-chocolate text-[10px] uppercase tracking-widest italic">Productivit√© optimale.</p>
                    </div>
                `;
                return;
            }

            allPending.forEach(task => {
                const isDaily = state.daily.some(t => t.id === task.id);
                const div = document.createElement('div');
                div.className = "flex items-center justify-between p-5 bg-white border border-stone-50 rounded-[2.5rem] shadow-xl hover:translate-y-[-2px] transition-all duration-300";
                div.innerHTML = `
                    <div class="flex items-center space-x-4">
                        <div class="w-1.5 h-10 rounded-full ${isDaily ? 'bg-moka-gold-start' : 'bg-moka-chocolate'}"></div>
                        <div>
                            <p class="font-black text-moka-chocolate text-sm line-clamp-1">${task.title}</p>
                            <p class="text-[8px] uppercase tracking-widest font-black text-moka-taupe opacity-50">
                                ${isDaily ? 'Daily Priority' : 'Weekly Pillar'} 
                                ${task.extra ? `‚Ä¢ ${task.extra}` : ''}
                            </p>
                        </div>
                    </div>
                    <button onclick="toggleTask('${isDaily ? 'daily' : 'weekly'}', ${task.id})" class="w-10 h-10 rounded-2xl bg-stone-50 flex items-center justify-center text-moka-gold-start hover:bg-moka-gold-start hover:text-white transition-all">
                        <i data-lucide="check" class="w-5 h-5"></i>
                    </button>
                `;
                container.appendChild(div);
            });
            lucide.createIcons();
        }

        function updateProgress() {
            const getPerc = (type) => {
                if (state[type].length === 0) return 0;
                const done = state[type].filter(t => t.done).length;
                return Math.round((done / state[type].length) * 100);
            };

            const dailyP = getPerc('daily');
            const weeklyP = getPerc('weekly');

            const dBar = document.getElementById('daily-progress-bar');
            const dText = document.getElementById('daily-progress-text');
            const wBar = document.getElementById('weekly-progress-bar');
            const wText = document.getElementById('weekly-progress-text');

            if(dBar) dBar.style.width = dailyP + '%';
            if(dText) dText.innerText = dailyP + '%';
            if(wBar) wBar.style.width = weeklyP + '%';
            if(wText) wText.innerText = weeklyP + '%';

            const dStat = document.getElementById('dash-daily-stat');
            const wStat = document.getElementById('dash-weekly-stat');
            if(dStat) dStat.innerText = dailyP + '%';
            if(wStat) wStat.innerText = weeklyP + '%';
        }

        function showToast(msg) {
            const toast = document.getElementById('toast');
            toast.querySelector('span').innerText = msg;
            toast.classList.remove('opacity-0', 'translate-y-10', 'pointer-events-none');
            toast.classList.add('opacity-100', 'translate-y-0');
            setTimeout(() => {
                toast.classList.add('opacity-0', 'translate-y-10', 'pointer-events-none');
                toast.classList.remove('opacity-100', 'translate-y-0');
            }, 3000);
        }

        function exportWhatsApp(scope = 'all') {
            if (!currentUser) return;
            
            let message = `‚òï *MOKA by RAYANE - RAPPORT 2026*\n`;
            message += `------------------------------------\n`;
            message += `üë§ *Identit√© :* ${currentUser.name}\n`;
            message += `üìÖ *Rapport du :* ${new Date().toLocaleDateString()}\n\n`;
            
            if(scope === 'all' || scope === 'daily') {
                message += `‚úÖ *MOKA DAILY (${document.getElementById('dash-daily-stat').innerText})*\n`;
                state.daily.forEach(t => message += `${t.done ? '‚óº' : '‚óª'} [${t.extra || '--:--'}] ${t.title}\n`);
                message += `\n`;
            }
            
            if(scope === 'all' || scope === 'weekly') {
                message += `üéØ *MOKA WEEKLY (${document.getElementById('dash-weekly-stat').innerText})*\n`;
                state.weekly.forEach(t => message += `${t.done ? '‚óº' : '‚óª'} (${t.extra || '---'}) ${t.title}\n`);
            }
            
            const encoded = encodeURIComponent(message);
            window.open(`https://wa.me/${currentUser.whatsapp}?text=${encoded}`);
        }

        // --- EVENT LISTENERS ---

        document.getElementById('login-form').addEventListener('submit', (e) => {
            e.preventDefault();
            const name = document.getElementById('login-name').value;
            const whatsapp = document.getElementById('login-whatsapp').value;
            loginAs({ name, whatsapp });
        });

        document.getElementById('menu-btn').addEventListener('click', openSidebar);
        overlay.addEventListener('click', closeSidebar);

        document.getElementById('add-daily-form').addEventListener('submit', (e) => {
            e.preventDefault();
            const input = document.getElementById('daily-input');
            const time = document.getElementById('daily-time');
            addTask('daily', input.value, time.value);
            input.value = '';
            time.value = '';
        });

        document.getElementById('add-weekly-form').addEventListener('submit', (e) => {
            e.preventDefault();
            const input = document.getElementById('weekly-input');
            const day = document.getElementById('weekly-day');
            addTask('weekly', input.value, day.value);
            input.value = '';
            day.value = '';
        });

        window.onload = init;

    </script>
</body>
</html>